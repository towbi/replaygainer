#!/usr/bin/perl -w

use strict;
use diagnostics;

use File::Find qw(find);
use Image::ExifTool qw(:Public);
use Data::Dumper;
use Try::Tiny;

use Replaygainer;
use Replaygainer::AudioFileInfo;

# scans music library for directories with music files that don't have replaygain information

my $exif_tool = new Image::ExifTool({Duplicates => 1});

my $total = 0;
my $total_touched = 0;
my $total_touched_audio = 0;

{
    my $done_dirs = {};
    sub scanfile {
        $total++;
        if (-f $_ and not defined $done_dirs->{$File::Find::dir}) {
            $total_touched++;
            my $info = $exif_tool->ImageInfo($_);

            try {
                my $foo = new Replaygainer::AudioFileInfo({
                    %$info,
                    dir  => $File::Find::dir,
                    file => $_,
                });
                $total_touched_audio++;
                unless ($foo->has_replaygain_track_gain()) {
                    print $foo->full_path() . " has no replaygain info.\n";
                }
            }
            catch {
                ;
            }

        }
    }
}

find(\&scanfile, ".");

print "\nScanned $total files total ($total_touched files touched, $total_touched_audio of those were audio files)\n";

